<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="æ˜Ÿå°˜èŠ±å›­ - æ²»æ„ˆç³»é—¯å…³å°æ¸¸æˆ">
  <title>âœ¨ æ˜Ÿå°˜èŠ±å›­ | ä¿®å¤æ˜Ÿå…‰ï¼Œæ²»æ„ˆå¿ƒçµ</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--primary:#6c5ce7;--secondary:#00cec9;--accent:#fdcb6e;--bg-dark:#2d3436;--bg-light:#f7f9fc;--text-dark:#2d3436;--text-light:#f7f9fc;--success:#00b894;--danger:#d63031;--border-radius:12px;--shadow:0 4px 12px rgba(0,0,0,0.15);--transition:all 0.3s ease}
    body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#6c5ce7,#a29bfe);color:var(--text-dark);height:100vh;overflow:hidden;touch-action:manipulation}
    #game-container{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;z-index:1}
    canvas{max-width:100%;max-height:100vh;display:block}
    #ui-container{position:fixed;top:0;left:0;width:100%;height:100%;z-index:100;pointer-events:none}
    #ui-container *{pointer-events:auto}
    .hidden{display:none!important}
    #loading-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#6c5ce7,#a29bfe);display:flex;justify-content:center;align-items:center;z-index:1000;transition:opacity 0.5s ease}
    .loading-content{text-align:center;color:white;padding:40px;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:var(--border-radius);box-shadow:var(--shadow)}
    .loading-spinner{width:60px;height:60px;border:4px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;margin:0 auto 20px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #main-menu{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,rgba(108,92,231,0.95),rgba(162,155,254,0.95));display:flex;justify-content:center;align-items:center;backdrop-filter:blur(10px)}
    .menu-content{background:white;padding:40px;border-radius:var(--border-radius);box-shadow:var(--shadow);max-width:90%;width:400px;text-align:center}
    .menu-content h1{font-size:2.5rem;margin-bottom:10px;background:linear-gradient(135deg,#6c5ce7,#00cec9);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .subtitle{color:#666;margin-bottom:30px;font-size:1.1rem}
    .btn-primary,.btn-secondary,.btn-danger{display:block;width:100%;padding:14px;margin:10px 0;border:none;border-radius:8px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:var(--transition);outline:none}
    .btn-primary{background:linear-gradient(135deg,var(--primary),#5e4ae9);color:white;box-shadow:0 4px 15px rgba(108,92,231,0.4)}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(108,92,231,0.6)}
    .btn-secondary{background:white;color:var(--primary);border:2px solid var(--primary)}
    .btn-secondary:hover{background:#f0f0ff}
    .btn-danger{background:var(--danger);color:white}
    .btn-danger:hover{background:#c22222}
    .btn-large{padding:18px;font-size:1.2rem}
    .btn-icon{background:rgba(255,255,255,0.8);border:2px solid white;width:44px;height:44px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:1.2rem;cursor:pointer;transition:var(--transition)}
    .btn-icon:hover{transform:scale(1.1);background:white}
    .save-info{background:#f0f0f0;padding:15px;border-radius:8px;margin:20px 0;text-align:left;font-size:0.95rem}
    .save-time{color:#888;font-size:0.9rem;margin-top:8px}
    .menu-footer{margin-top:30px;padding-top:20px;border-top:1px solid #eee;color:#888;font-size:0.9rem}
    #game-ui{position:absolute;top:0;left:0;width:100%;padding:20px;pointer-events:none}
    #game-ui *{pointer-events:auto}
    .ui-top{display:flex;justify-content:space-between;align-items:center;max-width:800px;margin:0 auto}
    .ui-item{background:rgba(255,255,255,0.9);backdrop-filter:blur(10px);padding:10px 20px;border-radius:50px;box-shadow:var(--shadow);font-weight:600;display:flex;align-items:center;gap:8px}
    .stars-count{background:linear-gradient(135deg,#ffd700,#ffed4e);color:#333}
    .level-info{background:linear-gradient(135deg,#6c5ce7,#a29bfe);color:white}
    #pause-menu,#settings-menu{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;backdrop-filter:blur(5px)}
    .pause-content,.settings-content{background:white;padding:30px;border-radius:var(--border-radius);box-shadow:var(--shadow);width:90%;max-width:400px;text-align:center}
    .pause-content h3,.settings-content h3{margin-bottom:25px;color:var(--primary)}
    .pause-content button{margin:10px 0;width:100%}
    #level-complete,#game-complete{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;backdrop-filter:blur(5px)}
    .modal-content{background:white;padding:30px;border-radius:var(--border-radius);box-shadow:var(--shadow);width:90%;max-width:450px;text-align:center}
    .modal-content h2{color:var(--primary);margin-bottom:20px;font-size:1.8rem}
    .stars-earned,.final-stats{margin:20px 0;padding:15px;background:#f9f9f9;border-radius:8px;text-align:left}
    .stars-earned p,.final-stats p{margin:8px 0;font-size:1.1rem}
    .garden-progress{margin:20px 0}
    .garden-progress p{margin-bottom:10px;font-weight:600;color:var(--primary)}
    .progress-bar{width:100%;height:20px;background:#e0e0e0;border-radius:10px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:10px;transition:width 0.5s ease}
    .completion-message{margin:20px 0;padding:15px;background:linear-gradient(135deg,#6c5ce7,#00cec9);color:white;border-radius:8px;font-size:1.1rem}
    .setting-item{display:flex;justify-content:space-between;align-items:center;margin:15px 0;padding:10px;background:#f5f5f5;border-radius:8px}
    .setting-item label{font-weight:600;color:var(--text-dark)}
    .setting-item input[type="range"]{width:150px;accent-color:var(--primary)}
    @media (max-width:768px){.menu-content{padding:30px 20px;width:95%}.menu-content h1{font-size:2rem}.btn-large{padding:16px}.ui-top{flex-direction:column;gap:15px;align-items:stretch}.ui-item{justify-content:center;font-size:1rem}}
    @media (max-width:480px){.loading-content{padding:30px 20px}.loading-spinner{width:40px;height:40px}.btn-icon{width:40px;height:40px;font-size:1rem}.pause-content,.settings-content,.modal-content{padding:20px;margin:10px}}
  </style>
</head>
<body>
  <div id="loading-screen">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p>å”¤é†’æ˜Ÿå…‰ä¸­...</p>
    </div>
  </div>

  <div id="game-container"></div>

  <div id="ui-container">
    <div id="game-ui" class="hidden">
      <div class="ui-top">
        <div class="ui-item stars-count">
          <span class="icon">â­</span>
          <span id="stars-display">0/10</span>
        </div>
        <div class="ui-item level-info">
          <span>ç¬¬ <span id="level-display">1</span> åŒº</span>
        </div>
        <button id="pause-btn" class="btn-icon" title="æš‚åœ">â¸ï¸</button>
      </div>
      
      <div id="pause-menu" class="hidden">
        <div class="pause-content">
          <h3>â¸ï¸ æš‚åœ</h3>
          <button id="resume-btn" class="btn-primary">ç»§ç»­</button>
          <button id="restart-btn" class="btn-secondary">é‡æ–°å¼€å§‹</button>
          <button id="save-btn" class="btn-secondary">ğŸ’¾ ä¿å­˜è¿›åº¦</button>
          <button id="settings-btn" class="btn-secondary">âš™ï¸ è®¾ç½®</button>
          <button id="back-menu-btn" class="btn-secondary">ğŸ  é€€å‡ºæ¸¸æˆ</button>
        </div>
      </div>

      <div id="settings-menu" class="hidden">
        <div class="settings-content">
          <h3>âš™ï¸ æ¸¸æˆè®¾ç½®</h3>
          <div class="setting-item">
            <label>éŸ³æ•ˆ</label>
            <input type="range" id="sfx-volume" min="0" max="1" step="0.1" value="1">
          </div>
          <div class="setting-item">
            <label>éŸ³ä¹</label>
            <input type="range" id="music-volume" min="0" max="1" step="0.1" value="0.5">
          </div>
          <button id="close-settings-btn" class="btn-primary">å®Œæˆ</button>
        </div>
      </div>
    </div>

    <div id="main-menu">
      <div class="menu-content">
        <h1>âœ¨ æ˜Ÿå°˜èŠ±å›­</h1>
        <p class="subtitle">æ”¶é›†æ˜Ÿå…‰ï¼Œå”¤é†’æ²‰ç¡çš„èŠ±å›­</p>
        
        <div id="start-section">
          <button id="new-game-btn" class="btn-primary btn-large">ğŸŒ± å¼€å§‹å†’é™©</button>
          <button id="continue-btn" class="btn-secondary btn-large hidden">â–¶ï¸ ç»§ç»­æ¸¸æˆ</button>
        </div>

        <div id="load-info" class="hidden">
          <div class="save-info">
            <p><strong>å½“å‰è¿›åº¦ï¼š</strong></p>
            <p>ç¬¬ <span id="save-level">-</span> åŒº Â· 
               æ˜Ÿæ˜Ÿ <span id="save-stars">0</span> é¢— Â· 
               æ€»æ—¶é•¿ <span id="save-time">0</span></p>
            <p class="save-time">æœ€åä¿å­˜ï¼š<span id="save-date">-</span></p>
          </div>
          <button id="delete-save-btn" class="btn-danger">ğŸ—‘ï¸ æ¸…é™¤å­˜æ¡£</button>
        </div>

        <div class="menu-footer">
          <p>ğŸ® ç‚¹å‡»/æ‹–æ‹½æ”¶é›†æ˜Ÿå…‰ Â· ğŸ’« éšæ—¶ä¿å­˜</p>
        </div>
      </div>
    </div>

    <div id="level-complete" class="hidden">
      <div class="modal-content">
        <h2>ğŸ‰ åŒºåŸŸä¿®å¤å®Œæˆï¼</h2>
        <div class="stars-earned">
          <p>æœ¬åŒºåŸŸæ”¶é›†ï¼š<span id="earned-stars">0</span> é¢—æ˜Ÿ</p>
          <p>æ€»è®¡ï¼š<span id="total-stars">0</span> é¢—æ˜Ÿ</p>
        </div>
        <div class="garden-progress">
          <p>èŠ±å›­ä¿®å¤åº¦ï¼š<span id="garden-percent">0</span>%</p>
          <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
          </div>
        </div>
        <button id="next-level-btn" class="btn-primary">â¡ï¸ å‰å¾€ä¸‹ä¸€åŒº</button>
        <button id="back-menu-complete-btn" class="btn-secondary">ğŸ  å›åˆ°èŠ±å›­</button>
      </div>
    </div>

    <div id="game-complete" class="hidden">
      <div class="modal-content">
        <h2>ğŸŒŸ èŠ±å›­å®Œå…¨ä¿®å¤ï¼</h2>
        <div class="final-stats">
          <p>æ”¶é›†æ˜Ÿæ˜Ÿï¼š<span id="final-stars">0</span> é¢—</p>
          <p>æ¸¸æˆæ—¶é•¿ï¼š<span id="final-time">0</span></p>
          <p>å®Œæˆæ—¥æœŸï¼š<span id="complete-date"></span></p>
        </div>
        <div class="completion-message">
          <p>âœ¨ ä½ è®©è¿™ç‰‡æ˜Ÿç©ºé‡æ–°é—ªè€€ï¼</p>
        </div>
        <button id="play-again-btn" class="btn-primary">ğŸŒ± å†ç©ä¸€æ¬¡</button>
        <button id="share-btn" class="btn-secondary">ğŸ“¤ åˆ†äº«æˆå°±</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
  <script>
    // ==================== å­˜æ¡£ç³»ç»Ÿ ====================
    class SaveSystem {
      constructor() {
        this.saveKey = 'star_garden_save_v2';
      }

      getLocalSave() {
        try {
          const data = localStorage.getItem(this.saveKey);
          return data ? JSON.parse(data) : null;
        } catch (e) {
          console.error('è¯»å–å­˜æ¡£å¤±è´¥:', e);
          return null;
        }
      }

      saveLocal(data) {
        try {
          const saveData = {
            ...data,
            savedAt: new Date().toISOString(),
            version: '2.0'
          };
          localStorage.setItem(this.saveKey, JSON.stringify(saveData));
          console.log('âœ… å­˜æ¡£å·²ä¿å­˜');
          return true;
        } catch (e) {
          console.error('âŒ ä¿å­˜å­˜æ¡£å¤±è´¥:', e);
          return false;
        }
      }

      deleteLocalSave() {
        try {
          localStorage.removeItem(this.saveKey);
          console.log('ğŸ—‘ï¸ å­˜æ¡£å·²åˆ é™¤');
          return true;
        } catch (e) {
          console.error('åˆ é™¤å­˜æ¡£å¤±è´¥:', e);
          return false;
        }
      }

      load() {
        return this.getLocalSave();
      }

      save(data) {
        return this.saveLocal(data);
      }

      delete() {
        this.deleteLocalSave();
      }

      formatDuration(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        if (h > 0) return `${h}å°æ—¶${m}åˆ†`;
        if (m > 0) return `${m}åˆ†${s}ç§’`;
        return `${s}ç§’`;
      }

      formatSaveDate(isoString) {
        if (!isoString) return 'ä»æœªä¿å­˜';
        const date = new Date(isoString);
        return date.toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      }
    }

    const saveSystem = new SaveSystem();

    // ==================== æ¸¸æˆçŠ¶æ€ ====================
    let gameState = {
      level: 1,
      starsCollected: 0,
      totalStars: 0,
      starsNeeded: 10,
      totalTime: 0,
      startTime: Date.now(),
      sfxVolume: 1.0,
      musicVolume: 0.5,
      paused: false
    };

    let game;
    let gameScene;

    // ==================== å†…è”ç²¾çµå›¾ (Base64) ====================
    // ä½¿ç”¨ Canvas ç”Ÿæˆç®€å•ä½†ç¾è§‚çš„ç²¾çµå›¾
    function generateSprites() {
      const canvas = document.createElement('canvas');
      canvas.width = 256;
      canvas.height = 64;
      const ctx = canvas.getContext('2d');

      // ç©å®¶è§’è‰² (ç´«è‰²åœ†å½¢å¸¦å…‰æ™•)
      ctx.beginPath();
      ctx.arc(32, 32, 24, 0, Math.PI * 2);
      ctx.fillStyle = '#6c5ce7';
      ctx.fill();
      
      ctx.beginPath();
      ctx.arc(32, 32, 16, 0, Math.PI * 2);
      ctx.fillStyle = '#a29bfe';
      ctx.fill();

      // æ˜Ÿæ˜Ÿ (é»„è‰²äº”è§’æ˜Ÿ)
      ctx.save();
      ctx.translate(96, 32);
      ctx.beginPath();
      for (let i = 0; i < 5; i++) {
        const angle = (i * Math.PI * 2 / 5) - Math.PI / 2;
        const outerX = Math.cos(angle) * 16;
        const outerY = Math.sin(angle) * 16;
        ctx.lineTo(outerX, outerY);
        const innerAngle = angle + Math.PI / 5;
        const innerX = Math.cos(innerAngle) * 8;
        const innerY = Math.sin(innerAngle) * 8;
        ctx.lineTo(innerX, innerY);
      }
      ctx.closePath();
      ctx.fillStyle = '#FFD700';
      ctx.fill();
      ctx.restore();

      // èŠ±æœµ1 (ç²‰è‰²)
      ctx.beginPath();
      ctx.arc(160, 24, 10, 0, Math.PI * 2);
      ctx.fillStyle = '#FFB6C1';
      ctx.fill();
      ctx.beginPath();
      ctx.arc(160, 40, 12, 0, Math.PI * 2);
      ctx.fillStyle = '#FF69B4';
      ctx.fill();
      ctx.fillStyle = '#8B4513';
      ctx.fillRect(158, 40, 4, 12);

      // èŠ±æœµ2 (è“è‰²)
      ctx.beginPath();
      ctx.arc(224, 24, 10, 0, Math.PI * 2);
      ctx.fillStyle = '#87CEFA';
      ctx.fill();
      ctx.beginPath();
      ctx.arc(224, 40, 12, 0, Math.PI * 2);
      ctx.fillStyle = '#1E90FF';
      ctx.fill();
      ctx.fillStyle = '#8B4513';
      ctx.fillRect(222, 40, 4, 12);

      return canvas.toDataURL('image/png');
    }

    const SPRITE_SHEET = generateSprites();

    // ==================== DOM äº‹ä»¶ ====================
    document.addEventListener('DOMContentLoaded', () => {
      // éšè—åŠ è½½å±
      setTimeout(() => {
        document.getElementById('loading-screen').style.opacity = '0';
        setTimeout(() => {
          document.getElementById('loading-screen').style.display = 'none';
        }, 500);
      }, 800);

      // æ£€æŸ¥å­˜æ¡£
      const saveData = saveSystem.load();
      if (saveData) {
        document.getElementById('continue-btn').classList.remove('hidden');
        document.getElementById('load-info').classList.remove('hidden');
        document.getElementById('save-level').textContent = saveData.level || 1;
        document.getElementById('save-stars').textContent = saveData.totalStars || 0;
        document.getElementById('save-time').textContent = saveSystem.formatDuration(saveData.totalTime || 0);
        document.getElementById('save-date').textContent = saveSystem.formatSaveDate(saveData.savedAt);
      }

      // æŒ‰é’®äº‹ä»¶
      document.getElementById('new-game-btn').addEventListener('click', startNewGame);
      document.getElementById('continue-btn').addEventListener('click', continueGame);
      document.getElementById('delete-save-btn').addEventListener('click', () => {
        if (confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤å­˜æ¡£å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
          saveSystem.delete();
          location.reload();
        }
      });
      document.getElementById('pause-btn').addEventListener('click', () => {
        if (gameScene) gameScene.togglePause();
      });
      document.getElementById('resume-btn').addEventListener('click', () => {
        if (gameScene) gameScene.togglePause();
      });
      document.getElementById('restart-btn').addEventListener('click', () => {
        if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å½“å‰åŒºåŸŸå—ï¼Ÿ')) {
          if (gameScene) {
            gameState.starsCollected = 0;
            gameScene.scene.restart();
            hidePauseMenu();
          }
        }
      });
      document.getElementById('save-btn').addEventListener('click', () => {
        if (gameScene) {
          gameScene.saveGame();
          alert('ğŸ’¾ è¿›åº¦å·²ä¿å­˜ï¼');
        }
      });
      document.getElementById('settings-btn').addEventListener('click', () => {
        document.getElementById('pause-menu').classList.add('hidden');
        document.getElementById('settings-menu').classList.remove('hidden');
      });
      document.getElementById('close-settings-btn').addEventListener('click', () => {
        document.getElementById('settings-menu').classList.add('hidden');
        document.getElementById('pause-menu').classList.remove('hidden');
      });
      document.getElementById('back-menu-btn').addEventListener('click', () => {
        if (confirm('ç¡®å®šè¦é€€å‡ºæ¸¸æˆå—ï¼Ÿè¿›åº¦ä¼šè‡ªåŠ¨ä¿å­˜')) {
          if (gameScene) gameScene.saveGame();
          showMainMenu();
        }
      });
      document.getElementById('back-menu-complete-btn').addEventListener('click', showMainMenu);
      document.getElementById('next-level-btn').addEventListener('click', () => {
        document.getElementById('level-complete').classList.add('hidden');
        gameState.level++;
        startGame();
      });
      document.getElementById('play-again-btn').addEventListener('click', () => {
        document.getElementById('game-complete').classList.add('hidden');
        startNewGame();
      });
      document.getElementById('share-btn').addEventListener('click', () => {
        const shareText = `æˆ‘åœ¨ã€Œæ˜Ÿå°˜èŠ±å›­ã€æ”¶é›†äº†${gameState.totalStars}é¢—æ˜Ÿæ˜Ÿï¼Œä¿®å¤äº†æ•´åº§èŠ±å›­ï¼âœ¨ä½ ä¹Ÿæ¥è¯•è¯•å§~ ${window.location.href}`;
        if (navigator.share) {
          navigator.share({ title: 'æ˜Ÿå°˜èŠ±å›­', text: shareText });
        } else {
          navigator.clipboard.writeText(shareText).then(() => {
            alert('ğŸ® æˆå°±å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n' + shareText);
          });
        }
      });

      // éŸ³é‡æ§åˆ¶
      document.getElementById('sfx-volume').addEventListener('input', (e) => {
        gameState.sfxVolume = parseFloat(e.target.value);
        if (gameScene?.starSound) gameScene.starSound.volume = gameState.sfxVolume;
      });
      document.getElementById('music-volume').addEventListener('input', (e) => {
        gameState.musicVolume = parseFloat(e.target.value);
        if (gameScene?.bgMusic) gameScene.bgMusic.volume = gameState.musicVolume;
      });
    });

    function showMainMenu() {
      document.getElementById('main-menu').classList.remove('hidden');
      document.getElementById('game-ui').classList.add('hidden');
      if (game) game.scene.pause('main');
    }

    function hidePauseMenu() {
      document.getElementById('pause-menu').classList.add('hidden');
      document.getElementById('settings-menu').classList.add('hidden');
    }

    function startNewGame() {
      gameState = {
        level: 1,
        starsCollected: 0,
        totalStars: 0,
        starsNeeded: 10,
        totalTime: 0,
        startTime: Date.now(),
        sfxVolume: 1.0,
        musicVolume: 0.5,
        paused: false
      };
      startGame();
    }

    function continueGame() {
      const saveData = saveSystem.load();
      if (saveData) {
        gameState = {
          level: saveData.level || 1,
          starsCollected: 0,
          totalStars: saveData.totalStars || 0,
          starsNeeded: 10,
          totalTime: saveData.totalTime || 0,
          startTime: Date.now(),
          sfxVolume: saveData.sfxVolume || 1.0,
          musicVolume: saveData.musicVolume || 0.5,
          paused: false
        };
      }
      startGame();
    }

    function startGame() {
      document.getElementById('main-menu').classList.add('hidden');
      document.getElementById('game-ui').classList.remove('hidden');
      
      if (game) game.destroy(true);
      
      game = new Phaser.Game({
        width: 800,
        height: 600,
        backgroundColor: '#87CEEB',
        scene: {
          preload: preload,
          create: create,
          update: update
        },
        physics: {
          default: 'arcade',
          arcade: { gravity: { y: 0 }, debug: false }
        },
        scale: {
          mode: Phaser.Scale.FIT,
          autoCenter: Phaser.Scale.CENTER_BOTH
        }
      });
    }

    // ==================== Phaser åœºæ™¯ ====================
    function preload() {
      this.load.spritesheet('sprites', SPRITE_SHEET, {
        frameWidth: 64,
        frameHeight: 64
      });
      
      // æ¨¡æ‹ŸéŸ³æ•ˆï¼ˆå®é™…é¡¹ç›®æ›¿æ¢ä¸ºçœŸå®éŸ³é¢‘æ–‡ä»¶ï¼‰
      this.starSound = {
        play: () => {
          if (gameState.sfxVolume > 0) {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            gainNode.gain.value = gameState.sfxVolume * 0.2;
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
          }
        },
        volume: gameState.sfxVolume
      };
      
      this.bgMusic = { volume: gameState.musicVolume };
    }

    function create() {
      gameScene = this;
      window.gameScene = this;
      
      // èƒŒæ™¯ - æ ¹æ®å…³å¡å˜åŒ–
      const bgColors = [
        '#87CEEB', // 1: å¤©ç©ºè“
        '#FFB6C1', // 2: ç²‰çº¢
        '#98D8C8', // 3: è–„è·ç»¿
        '#FFD700', // 4: é‡‘è‰²
        '#DDA0DD', // 5: æ¢…å­ç´«
        '#87CEFA', // 6: æµ…è“
        '#FFA07A', // 7: æµ…æ©™
        '#90EE90', // 8: æµ…ç»¿
        '#F0E68C', // 9: å¡å…¶
        '#E6E6FA'  // 10: è–°è¡£è‰ç´«
      ];
      
      const bgColor = Phaser.Display.Color.ValueToColor(bgColors[(gameState.level - 1) % bgColors.length]);
      this.add.rectangle(400, 300, 800, 600, bgColor.color, 0.9).setOrigin(0.5);
      
      // äº‘æœµ/è£…é¥°ï¼ˆæ ¹æ®å…³å¡å˜åŒ–ï¼‰
      for (let i = 0; i < 8; i++) {
        const x = Phaser.Math.Between(50, 750);
        const y = Phaser.Math.Between(80, 250);
        const size = Phaser.Math.Between(30, 80);
        const color = gameState.level <= 3 ? 0xFFFFFF : 
                      gameState.level <= 6 ? 0xFFE4E1 : 0xE6E6FA;
        
        const cloud = this.add.ellipse(x, y, size, size * 0.6, color, 0.7);
        
        this.tweens.add({
          targets: cloud,
          x: x + Phaser.Math.Between(100, 300),
          duration: Phaser.Math.Between(25000, 45000),
          repeat: -1,
          yoyo: true,
          ease: 'Sine.easeInOut'
        });
      }
      
      // è‰åœ°
      this.add.rectangle(400, 580, 800, 120, 0x7CFC00, 0.9).setOrigin(0.5);
      
      // èŠ±æœµè£…é¥°
      const flowerTypes = gameState.level <= 5 ? [2, 3] : [3, 2]; // åˆ‡æ¢èŠ±æœµå¸§
      for (let i = 0; i < 15; i++) {
        const x = Phaser.Math.Between(80, 720);
        const y = Phaser.Math.Between(480, 560);
        const scale = Phaser.Math.FloatBetween(0.7, 1.2);
        const frame = Phaser.Utils.Array.GetRandom(flowerTypes);
        
        const flower = this.add.sprite(x, y, 'sprites', frame)
          .setScale(scale)
          .setDepth(5);
        
        // è½»å¾®æ‘‡æ‘†
        this.tweens.add({
          targets: flower,
          angle: Phaser.Math.Between(-5, 5),
          duration: Phaser.Math.Between(2000, 4000),
          repeat: -1,
          yoyo: true,
          ease: 'Sine.easeInOut'
        });
      }
      
      // ç©å®¶è§’è‰²
      this.player = this.add.sprite(400, 350, 'sprites', 0)
        .setScale(1.2)
        .setDepth(10);
      
      // ç©å®¶å…‰æ™•
      const glow = this.add.circle(400, 350, 40, 0xffffff, 0.2)
        .setDepth(9);
      
      this.tweens.add({
        targets: glow,
        alpha: { from: 0.3, to: 0.1 },
        duration: 1200,
        repeat: -1,
        yoyo: true
      });
      
      // æ‹–æ‹½æ§åˆ¶
      this.input.setDraggable(this.player);
      this.input.on('drag', (pointer, gameObject, dragX, dragY) => {
        gameObject.x = Phaser.Math.Clamp(dragX, 60, 740);
        gameObject.y = Phaser.Math.Clamp(dragY, 120, 500);
        glow.x = gameObject.x;
        glow.y = gameObject.y;
      });
      
      // ç‚¹å‡»ç§»åŠ¨
      this.input.on('pointerdown', (pointer) => {
        if (!Phaser.Geom.Circle.Contains(new Phaser.Geom.Circle(this.player.x, this.player.y, 40), pointer.x, pointer.y)) {
          this.tweens.add({
            targets: [this.player, glow],
            x: Phaser.Math.Clamp(pointer.x, 60, 740),
            y: Phaser.Math.Clamp(pointer.y, 120, 500),
            duration: 350,
            ease: 'Power2'
          });
        }
      });
      
      // æ˜Ÿæ˜Ÿç»„
      this.stars = this.physics.add.group();
      this.createStars(gameState.starsNeeded);
      
      // ç¢°æ’æ£€æµ‹
      this.physics.add.overlap(this.player, this.stars, this.collectStar, null, this);
      
      // è´è¶è£…é¥°
      for (let i = 0; i < 6; i++) {
        const butterfly = this.add.sprite(
          Phaser.Math.Between(100, 700),
          Phaser.Math.Between(150, 400),
          'sprites',
          1
        ).setScale(0.8).setDepth(7);
        
        this.tweens.add({
          targets: butterfly,
          x: butterfly.x + Phaser.Math.Between(-150, 150),
          y: butterfly.y + Phaser.Math.Between(-80, 80),
          duration: Phaser.Math.Between(3000, 6000),
          repeat: -1,
          yoyo: true,
          ease: 'Sine.easeInOut'
        });
        
        // æ—‹è½¬
        this.tweens.add({
          targets: butterfly,
          angle: 360,
          duration: 2000,
          repeat: -1
        });
      }
      
      // UI æ›´æ–°
      this.updateUI();
      
      // è®¡æ—¶å™¨
      this.time.addEvent({
        delay: 1000,
        callback: () => {
          if (!gameState.paused) {
            gameState.totalTime++;
          }
        },
        loop: true
      });
      
      // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆæ‰€æœ‰å…³å¡
      if (gameState.level > 10) {
        this.gameComplete();
      }
    }

    create.prototype.createStars = function(count) {
      this.stars.clear(true, true);
      
      for (let i = 0; i < count; i++) {
        const star = this.stars.create(
          Phaser.Math.Between(100, 700),
          Phaser.Math.Between(150, 450),
          'sprites',
          1
        ).setScale(0.9).setDepth(8);
        
        // é—ªçƒ
        this.tweens.add({
          targets: star,
          alpha: { from: 1, to: 0.6 },
          duration: 900,
          repeat: -1,
          yoyo: true
        });
        
        // æ¼‚æµ®
        this.tweens.add({
          targets: star,
          y: star.y + Phaser.Math.Between(-25, 25),
          duration: Phaser.Math.Between(2500, 4500),
          repeat: -1,
          yoyo: true,
          ease: 'Sine.easeInOut'
        });
      }
    };

    create.prototype.collectStar = function(player, star) {
      star.disableBody(true, true);
      
      // éŸ³æ•ˆ
      this.starSound.play();
      
      // ç²’å­æ•ˆæœ
      const particles = this.add.particles(0xFFD700);
      const emitter = particles.createEmitter({
        speed: { min: 100, max: 200 },
        scale: { start: 0.4, end: 0 },
        quantity: 12,
        lifespan: 600,
        blendMode: 'ADD',
        gravityY: 0
      });
      emitter.explode(15, star.x, star.y);
      this.time.delayedCall(700, () => particles.destroy());
      
      // è®¡åˆ†
      gameState.starsCollected++;
      gameState.totalStars++;
      this.updateUI();
      
      // æ£€æŸ¥å®Œæˆ
      if (gameState.starsCollected >= gameState.starsNeeded) {
        this.levelComplete();
      }
    };

    create.prototype.updateUI = function() {
      document.getElementById('stars-display').textContent = 
        `${gameState.starsCollected}/${gameState.starsNeeded}`;
      document.getElementById('level-display').textContent = gameState.level;
    };

    create.prototype.levelComplete = function() {
      document.getElementById('level-complete').classList.remove('hidden');
      document.getElementById('earned-stars').textContent = gameState.starsCollected;
      document.getElementById('total-stars').textContent = gameState.totalStars;
      
      const progress = Math.min(100, Math.round((gameState.level / 10) * 100));
      document.getElementById('garden-percent').textContent = progress;
      document.getElementById('progress-fill').style.width = `${progress}%`;
      
      gameState.paused = true;
      this.scene.pause();
      
      // è‡ªåŠ¨ä¿å­˜
      this.saveGame();
    };

    create.prototype.gameComplete = function() {
      document.getElementById('game-complete').classList.remove('hidden');
      document.getElementById('final-stars').textContent = gameState.totalStars;
      document.getElementById('final-time').textContent = saveSystem.formatDuration(gameState.totalTime);
      document.getElementById('complete-date').textContent = new Date().toLocaleDateString('zh-CN');
      
      gameState.paused = true;
      this.scene.pause();
      
      // ä¿å­˜æœ€ç»ˆè¿›åº¦
      this.saveGame();
    };

    create.prototype.saveGame = function() {
      const saveData = {
        level: gameState.level,
        totalStars: gameState.totalStars,
        totalTime: gameState.totalTime,
        sfxVolume: gameState.sfxVolume,
        musicVolume: gameState.musicVolume
      };
      
      saveSystem.save(saveData);
      
      // æ›´æ–°èœå•æ˜¾ç¤ºï¼ˆå¦‚æœè¿”å›ä¸»èœå•ï¼‰
      if (document.getElementById('main-menu').classList.contains('hidden') === false) {
        document.getElementById('save-level').textContent = saveData.level;
        document.getElementById('save-stars').textContent = saveData.totalStars;
        document.getElementById('save-time').textContent = saveSystem.formatDuration(saveData.totalTime);
        document.getElementById('save-date').textContent = saveSystem.formatSaveDate(new Date().toISOString());
        document.getElementById('continue-btn').classList.remove('hidden');
        document.getElementById('load-info').classList.remove('hidden');
      }
    };

    create.prototype.togglePause = function() {
      gameState.paused = !gameState.paused;
      
      if (gameState.paused) {
        this.scene.pause();
        document.getElementById('pause-menu').classList.remove('hidden');
      } else {
        this.scene.resume();
        document.getElementById('pause-menu').classList.add('hidden');
        document.getElementById('settings-menu').classList.add('hidden');
      }
    };

    function update() {
      // ç©ºå®ç°ï¼ˆå¯æ ¹æ®éœ€è¦æ·»åŠ é€»è¾‘ï¼‰
    }
  </script>
</body>
</html>
