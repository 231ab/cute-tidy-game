<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="æ˜Ÿå°˜èŠ±å›­ - æ²»æ„ˆç³»é—¯å…³å°æ¸¸æˆ">
  <title>âœ¨ æ˜Ÿå°˜èŠ±å›­ | ä¿®å¤æ˜Ÿå…‰ï¼Œæ²»æ„ˆå¿ƒçµ</title>
  <style>
    /* CSS ä¿æŒä¸å˜ï¼ŒåŸæ ·å¼å†™å¾—å¾ˆå¥½ */
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--primary:#6c5ce7;--secondary:#00cec9;--accent:#fdcb6e;--bg-dark:#2d3436;--bg-light:#f7f9fc;--text-dark:#2d3436;--text-light:#f7f9fc;--success:#00b894;--danger:#d63031;--border-radius:12px;--shadow:0 4px 12px rgba(0,0,0,0.15);--transition:all 0.3s ease}
    body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#6c5ce7,#a29bfe);color:var(--text-dark);height:100vh;overflow:hidden;touch-action:manipulation;user-select:none;}
    #game-container{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;z-index:1}
    canvas{max-width:100%;max-height:100vh;display:block;box-shadow: var(--shadow); border-radius: var(--border-radius);}
    #ui-container{position:fixed;top:0;left:0;width:100%;height:100%;z-index:100;pointer-events:none}
    #ui-container *{pointer-events:auto}
    .hidden{display:none!important}
    #loading-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#6c5ce7,#a29bfe);display:flex;justify-content:center;align-items:center;z-index:1000;transition:opacity 0.5s ease}
    .loading-content{text-align:center;color:white;padding:40px;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:var(--border-radius);box-shadow:var(--shadow)}
    .loading-spinner{width:60px;height:60px;border:4px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;margin:0 auto 20px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #main-menu{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,rgba(108,92,231,0.95),rgba(162,155,254,0.95));display:flex;justify-content:center;align-items:center;backdrop-filter:blur(10px)}
    .menu-content{background:white;padding:40px;border-radius:var(--border-radius);box-shadow:var(--shadow);max-width:90%;width:400px;text-align:center}
    .menu-content h1{font-size:2.5rem;margin-bottom:10px;background:linear-gradient(135deg,#6c5ce7,#00cec9);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .subtitle{color:#666;margin-bottom:30px;font-size:1.1rem}
    .btn-primary,.btn-secondary,.btn-danger{display:block;width:100%;padding:14px;margin:10px 0;border:none;border-radius:8px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:var(--transition);outline:none}
    .btn-primary{background:linear-gradient(135deg,var(--primary),#5e4ae9);color:white;box-shadow:0 4px 15px rgba(108,92,231,0.4)}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(108,92,231,0.6)}
    .btn-secondary{background:white;color:var(--primary);border:2px solid var(--primary)}
    .btn-secondary:hover{background:#f0f0ff}
    .btn-danger{background:var(--danger);color:white}
    .btn-danger:hover{background:#c22222}
    .btn-large{padding:18px;font-size:1.2rem}
    .btn-icon{background:rgba(255,255,255,0.8);border:2px solid white;width:44px;height:44px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:1.2rem;cursor:pointer;transition:var(--transition)}
    .btn-icon:hover{transform:scale(1.1);background:white}
    .save-info{background:#f0f0f0;padding:15px;border-radius:8px;margin:20px 0;text-align:left;font-size:0.95rem}
    .save-time{color:#888;font-size:0.9rem;margin-top:8px}
    .menu-footer{margin-top:30px;padding-top:20px;border-top:1px solid #eee;color:#888;font-size:0.9rem}
    #game-ui{position:absolute;top:0;left:0;width:100%;padding:20px;pointer-events:none}
    #game-ui *{pointer-events:auto}
    .ui-top{display:flex;justify-content:space-between;align-items:center;max-width:800px;margin:0 auto}
    .ui-item{background:rgba(255,255,255,0.9);backdrop-filter:blur(10px);padding:10px 20px;border-radius:50px;box-shadow:var(--shadow);font-weight:600;display:flex;align-items:center;gap:8px}
    .stars-count{background:linear-gradient(135deg,#ffd700,#ffed4e);color:#333}
    .level-info{background:linear-gradient(135deg,#6c5ce7,#a29bfe);color:white}
    #pause-menu,#settings-menu{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;backdrop-filter:blur(5px)}
    .pause-content,.settings-content{background:white;padding:30px;border-radius:var(--border-radius);box-shadow:var(--shadow);width:90%;max-width:400px;text-align:center}
    .pause-content h3,.settings-content h3{margin-bottom:25px;color:var(--primary)}
    .pause-content button{margin:10px 0;width:100%}
    #level-complete,#game-complete{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;backdrop-filter:blur(5px)}
    .modal-content{background:white;padding:30px;border-radius:var(--border-radius);box-shadow:var(--shadow);width:90%;max-width:450px;text-align:center}
    .modal-content h2{color:var(--primary);margin-bottom:20px;font-size:1.8rem}
    .stars-earned,.final-stats{margin:20px 0;padding:15px;background:#f9f9f9;border-radius:8px;text-align:left}
    .stars-earned p,.final-stats p{margin:8px 0;font-size:1.1rem}
    .garden-progress{margin:20px 0}
    .garden-progress p{margin-bottom:10px;font-weight:600;color:var(--primary)}
    .progress-bar{width:100%;height:20px;background:#e0e0e0;border-radius:10px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:10px;transition:width 0.5s ease}
    .completion-message{margin:20px 0;padding:15px;background:linear-gradient(135deg,#6c5ce7,#00cec9);color:white;border-radius:8px;font-size:1.1rem}
    .setting-item{display:flex;justify-content:space-between;align-items:center;margin:15px 0;padding:10px;background:#f5f5f5;border-radius:8px}
    .setting-item label{font-weight:600;color:var(--text-dark)}
    .setting-item input[type="range"]{width:150px;accent-color:var(--primary)}
    @media (max-width:768px){.menu-content{padding:30px 20px;width:95%}.menu-content h1{font-size:2rem}.btn-large{padding:16px}.ui-top{flex-direction:column;gap:15px;align-items:stretch}.ui-item{justify-content:center;font-size:1rem}}
    @media (max-width:480px){.loading-content{padding:30px 20px}.loading-spinner{width:40px;height:40px}.btn-icon{width:40px;height:40px;font-size:1rem}.pause-content,.settings-content,.modal-content{padding:20px;margin:10px}}
  </style>
</head>
<body>
  <!-- DOM å…ƒç´ ç»“æ„ä¿æŒä¸å˜ -->
  <div id="loading-screen">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p>å”¤é†’æ˜Ÿå…‰ä¸­...</p>
    </div>
  </div>

  <div id="game-container"></div>

  <div id="ui-container">
    <div id="game-ui" class="hidden">
      <div class="ui-top">
        <div class="ui-item stars-count">
          <span class="icon">â­</span>
          <span id="stars-display">0/10</span>
        </div>
        <div class="ui-item level-info">
          <span>ç¬¬ <span id="level-display">1</span> åŒº</span>
        </div>
        <button id="pause-btn" class="btn-icon" title="æš‚åœ">â¸ï¸</button>
      </div>
      
      <div id="pause-menu" class="hidden">
        <div class="pause-content">
          <h3>â¸ï¸ æš‚åœ</h3>
          <button id="resume-btn" class="btn-primary">ç»§ç»­</button>
          <button id="restart-btn" class="btn-secondary">é‡æ–°å¼€å§‹</button>
          <button id="save-btn" class="btn-secondary">ğŸ’¾ ä¿å­˜è¿›åº¦</button>
          <button id="settings-btn" class="btn-secondary">âš™ï¸ è®¾ç½®</button>
          <button id="back-menu-btn" class="btn-secondary">ğŸ  é€€å‡ºæ¸¸æˆ</button>
        </div>
      </div>

      <div id="settings-menu" class="hidden">
        <div class="settings-content">
          <h3>âš™ï¸ æ¸¸æˆè®¾ç½®</h3>
          <div class="setting-item">
            <label>éŸ³æ•ˆ</label>
            <input type="range" id="sfx-volume" min="0" max="1" step="0.1" value="1">
          </div>
          <div class="setting-item">
            <label>éŸ³ä¹</label>
            <input type="range" id="music-volume" min="0" max="1" step="0.1" value="0.5">
          </div>
          <button id="close-settings-btn" class="btn-primary">å®Œæˆ</button>
        </div>
      </div>
    </div>

    <div id="main-menu">
      <div class="menu-content">
        <h1>âœ¨ æ˜Ÿå°˜èŠ±å›­</h1>
        <p class="subtitle">æ”¶é›†æ˜Ÿå…‰ï¼Œå”¤é†’æ²‰ç¡çš„èŠ±å›­</p>
        
        <div id="start-section">
          <button id="new-game-btn" class="btn-primary btn-large">ğŸŒ± å¼€å§‹å†’é™©</button>
          <button id="continue-btn" class="btn-secondary btn-large hidden">â–¶ï¸ ç»§ç»­æ¸¸æˆ</button>
        </div>

        <div id="load-info" class="hidden">
          <div class="save-info">
            <p><strong>å½“å‰è¿›åº¦ï¼š</strong></p>
            <p>ç¬¬ <span id="save-level">-</span> åŒº Â· 
               æ˜Ÿæ˜Ÿ <span id="save-stars">0</span> é¢— Â· 
               æ€»æ—¶é•¿ <span id="save-time">0</span></p>
            <p class="save-time">æœ€åä¿å­˜ï¼š<span id="save-date">-</span></p>
          </div>
          <button id="delete-save-btn" class="btn-danger">ğŸ—‘ï¸ æ¸…é™¤å­˜æ¡£</button>
        </div>

        <div class="menu-footer">
          <p>ğŸ® ç‚¹å‡»/æ‹–æ‹½æ”¶é›†æ˜Ÿå…‰ Â· ğŸ’« éšæ—¶ä¿å­˜</p>
        </div>
      </div>
    </div>

    <div id="level-complete" class="hidden">
      <div class="modal-content">
        <h2>ğŸ‰ åŒºåŸŸä¿®å¤å®Œæˆï¼</h2>
        <div class="stars-earned">
          <p>æœ¬åŒºåŸŸæ”¶é›†ï¼š<span id="earned-stars">0</span> é¢—æ˜Ÿ</p>
          <p>æ€»è®¡ï¼š<span id="total-stars">0</span> é¢—æ˜Ÿ</p>
        </div>
        <div class="garden-progress">
          <p>èŠ±å›­ä¿®å¤åº¦ï¼š<span id="garden-percent">0</span>%</p>
          <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
          </div>
        </div>
        <button id="next-level-btn" class="btn-primary">â¡ï¸ å‰å¾€ä¸‹ä¸€åŒº</button>
        <button id="back-menu-complete-btn" class="btn-secondary">ğŸ  å›åˆ°èŠ±å›­</button>
      </div>
    </div>

    <div id="game-complete" class="hidden">
      <div class="modal-content">
        <h2>ğŸŒŸ èŠ±å›­å®Œå…¨ä¿®å¤ï¼</h2>
        <div class="final-stats">
          <p>æ”¶é›†æ˜Ÿæ˜Ÿï¼š<span id="final-stars">0</span> é¢—</p>
          <p>æ¸¸æˆæ—¶é•¿ï¼š<span id="final-time">0</span></p>
          <p>å®Œæˆæ—¥æœŸï¼š<span id="complete-date"></span></p>
        </div>
        <div class="completion-message">
          <p>âœ¨ ä½ è®©è¿™ç‰‡æ˜Ÿç©ºé‡æ–°é—ªè€€ï¼</p>
        </div>
        <button id="play-again-btn" class="btn-primary">ğŸŒ± å†ç©ä¸€æ¬¡</button>
        <button id="share-btn" class="btn-secondary">ğŸ“¤ åˆ†äº«æˆå°±</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
  <script>
    // ==================== å­˜æ¡£ç³»ç»Ÿ ====================
    class SaveSystem {
      constructor() {
        this.saveKey = 'star_garden_save_v2';
      }

      getLocalSave() {
        try {
          const data = localStorage.getItem(this.saveKey);
          return data ? JSON.parse(data) : null;
        } catch (e) {
          console.error('è¯»å–å­˜æ¡£å¤±è´¥:', e);
          return null;
        }
      }

      saveLocal(data) {
        try {
          const saveData = {
            ...data,
            savedAt: new Date().toISOString(),
            version: '2.0'
          };
          localStorage.setItem(this.saveKey, JSON.stringify(saveData));
          return true;
        } catch (e) {
          console.error('âŒ ä¿å­˜å­˜æ¡£å¤±è´¥:', e);
          return false;
        }
      }

      deleteLocalSave() {
        localStorage.removeItem(this.saveKey);
      }

      formatDuration(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        if (h > 0) return `${h}å°æ—¶${m}åˆ†`;
        if (m > 0) return `${m}åˆ†${s}ç§’`;
        return `${s}ç§’`;
      }

      formatSaveDate(isoString) {
        if (!isoString) return 'ä»æœªä¿å­˜';
        const date = new Date(isoString);
        return date.toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      }
    }

    const saveSystem = new SaveSystem();

    // ==================== æ¸¸æˆçŠ¶æ€ ====================
    let gameState = {
      level: 1,
      starsCollected: 0,
      totalStars: 0,
      starsNeeded: 10,
      totalTime: 0,
      sfxVolume: 1.0,
      musicVolume: 0.5,
      paused: false
    };

    let game;
    // ç”¨äºUIæ§åˆ¶çš„å¼•ç”¨
    let activeScene = null;

    // ==================== èµ„æºç”Ÿæˆ ====================
    function generateSprites() {
      const canvas = document.createElement('canvas');
      canvas.width = 256;
      canvas.height = 64;
      const ctx = canvas.getContext('2d');

      // ç©å®¶è§’è‰²
      ctx.beginPath();
      ctx.arc(32, 32, 24, 0, Math.PI * 2);
      ctx.fillStyle = '#6c5ce7';
      ctx.fill();
      ctx.beginPath();
      ctx.arc(32, 32, 16, 0, Math.PI * 2);
      ctx.fillStyle = '#a29bfe';
      ctx.fill();

      // æ˜Ÿæ˜Ÿ (ä¿®æ­£ç»˜åˆ¶é€»è¾‘)
      ctx.save();
      ctx.translate(96, 32);
      ctx.beginPath();
      // ç§»åŠ¨åˆ°ç¬¬ä¸€ä¸ªç‚¹ï¼Œé¿å…è·¯å¾„é—®é¢˜
      ctx.moveTo(0, -16);
      for (let i = 0; i < 5; i++) {
        const angle = (i * Math.PI * 2 / 5) - Math.PI / 2;
        const outerX = Math.cos(angle) * 16;
        const outerY = Math.sin(angle) * 16;
        ctx.lineTo(outerX, outerY);
        const innerAngle = angle + Math.PI / 5;
        const innerX = Math.cos(innerAngle) * 8;
        const innerY = Math.sin(innerAngle) * 8;
        ctx.lineTo(innerX, innerY);
      }
      ctx.closePath();
      ctx.fillStyle = '#FFD700';
      ctx.fill();
      ctx.restore();

      // èŠ±æœµ1
      ctx.beginPath();
      ctx.arc(160, 24, 10, 0, Math.PI * 2);
      ctx.fillStyle = '#FFB6C1';
      ctx.fill();
      ctx.beginPath();
      ctx.arc(160, 40, 12, 0, Math.PI * 2);
      ctx.fillStyle = '#FF69B4';
      ctx.fill();
      ctx.fillStyle = '#8B4513';
      ctx.fillRect(158, 40, 4, 12);

      // èŠ±æœµ2
      ctx.beginPath();
      ctx.arc(224, 24, 10, 0, Math.PI * 2);
      ctx.fillStyle = '#87CEFA';
      ctx.fill();
      ctx.beginPath();
      ctx.arc(224, 40, 12, 0, Math.PI * 2);
      ctx.fillStyle = '#1E90FF';
      ctx.fill();
      ctx.fillStyle = '#8B4513';
      ctx.fillRect(222, 40, 4, 12);

      return canvas.toDataURL('image/png');
    }

    const SPRITE_SHEET = generateSprites();

    // ==================== Phaser Scene Class (æ ¸å¿ƒä¿®å¤) ====================
    class MainScene extends Phaser.Scene {
      constructor() {
        super('MainScene');
      }

      preload() {
        this.load.spritesheet('sprites', SPRITE_SHEET, {
          frameWidth: 64,
          frameHeight: 64
        });

        // ç®€æ˜“éŸ³æ•ˆåˆæˆå™¨
        this.playStarSound = () => {
          if (gameState.sfxVolume > 0) {
            try {
              const AudioContext = window.AudioContext || window.webkitAudioContext;
              if (!AudioContext) return;
              const audioCtx = new AudioContext();
              const oscillator = audioCtx.createOscillator();
              const gainNode = audioCtx.createGain();
              oscillator.connect(gainNode);
              gainNode.connect(audioCtx.destination);
              gainNode.gain.setValueAtTime(gameState.sfxVolume * 0.2, audioCtx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
              oscillator.frequency.value = 800 + Math.random() * 200;
              oscillator.type = 'sine';
              oscillator.start();
              oscillator.stop(audioCtx.currentTime + 0.1);
            } catch(e) {}
          }
        };
      }

      create() {
        activeScene = this; // ç»‘å®šåˆ°å¤–éƒ¨å¼•ç”¨
        gameState.starsCollected = 0; // é‡ç½®å½“å‰å…³å¡æ”¶é›†
        
        // 1. èƒŒæ™¯ç”Ÿæˆ
        const bgColors = [
          0x87CEEB, 0xFFB6C1, 0x98D8C8, 0xFFD700, 0xDDA0DD,
          0x87CEFA, 0xFFA07A, 0x90EE90, 0xF0E68C, 0xE6E6FA
        ];
        const color = bgColors[(gameState.level - 1) % bgColors.length] || 0x87CEEB;
        this.add.rectangle(400, 300, 800, 600, color).setOrigin(0.5);

        // 2. åŠ¨æ€äº‘æœµ
        for (let i = 0; i < 6; i++) {
          const x = Phaser.Math.Between(50, 750);
          const y = Phaser.Math.Between(50, 250);
          const cloud = this.add.ellipse(x, y, Phaser.Math.Between(40, 90), 30, 0xFFFFFF, 0.6);
          this.tweens.add({
            targets: cloud,
            x: x + Phaser.Math.Between(-100, 100),
            duration: Phaser.Math.Between(20000, 40000),
            yoyo: true,
            repeat: -1
          });
        }

        // 3. åœ°é¢
        this.add.rectangle(400, 580, 800, 80, 0x7CFC00).setOrigin(0.5);

        // 4. èŠ±æœµè£…é¥°
        for (let i = 0; i < 12; i++) {
          const x = Phaser.Math.Between(50, 750);
          const y = Phaser.Math.Between(540, 560);
          const frame = Phaser.Math.Between(2, 3);
          const flower = this.add.sprite(x, y, 'sprites', frame).setScale(0.8);
          this.tweens.add({
            targets: flower,
            angle: { from: -5, to: 5 },
            duration: Phaser.Math.Between(2000, 3000),
            yoyo: true,
            repeat: -1
          });
        }

        // 5. ç©å®¶
        this.player = this.physics.add.sprite(400, 350, 'sprites', 0).setScale(1.2);
        this.player.setCollideWorldBounds(true);
        this.player.body.allowGravity = false;
        
        // ç©å®¶å…‰æ™•
        this.glow = this.add.circle(400, 350, 40, 0xFFFFFF, 0.2);
        this.tweens.add({
          targets: this.glow,
          scale: 1.2,
          alpha: 0.1,
          duration: 1000,
          yoyo: true,
          repeat: -1
        });

        // 6. äº¤äº’
        this.player.setInteractive({ draggable: true });
        
        this.input.on('drag', (pointer, gameObject, dragX, dragY) => {
          if (gameState.paused) return;
          gameObject.x = dragX;
          gameObject.y = dragY;
          this.glow.x = dragX;
          this.glow.y = dragY;
        });

        this.input.on('pointerdown', (pointer) => {
          if (gameState.paused) return;
          // ç®€å•çš„ç‚¹å‡»ç§»åŠ¨é€»è¾‘
          this.tweens.add({
            targets: [this.player, this.glow],
            x: pointer.x,
            y: pointer.y,
            duration: 500,
            ease: 'Power2'
          });
        });

        // 7. æ˜Ÿæ˜Ÿç»„
        this.stars = this.physics.add.group();
        this.createStars(gameState.starsNeeded);

        // 8. ç¢°æ’æ£€æµ‹
        this.physics.add.overlap(this.player, this.stars, this.collectStar, null, this);

        // UI åˆå§‹åŒ–
        this.updateUI();

        // è®¡æ—¶å™¨äº‹ä»¶
        this.timeEvent = this.time.addEvent({
          delay: 1000,
          callback: () => {
            if (!gameState.paused) gameState.totalTime++;
          },
          loop: true
        });
      }

      createStars(count) {
        // ç¡®ä¿ä¸ä¼šç”Ÿæˆåœ¨å·²æœ‰çš„æ˜Ÿæ˜Ÿä½ç½®è¿‡äºå¯†é›†
        for (let i = 0; i < count; i++) {
          const x = Phaser.Math.Between(50, 750);
          const y = Phaser.Math.Between(100, 500);
          const star = this.stars.create(x, y, 'sprites', 1).setScale(0.8);
          
          this.tweens.add({
            targets: star,
            y: y + 15,
            duration: Phaser.Math.Between(1500, 3000),
            yoyo: true,
            repeat: -1,
            ease: 'Sine.easeInOut'
          });
        }
      }

      collectStar(player, star) {
        star.disableBody(true, true);
        this.playStarSound();
        
        // ç²’å­ç‰¹æ•ˆ
        const particles = this.add.particles(star.x, star.y, 'sprites', {
          frame: 1,
          speed: 100,
          scale: { start: 0.4, end: 0 },
          blendMode: 'ADD',
          lifespan: 500,
          gravityY: 0,
          quantity: 8
        });
        
        // è‡ªåŠ¨é”€æ¯ç²’å­ç³»ç»Ÿ
        this.time.delayedCall(500, () => particles.destroy());

        gameState.starsCollected++;
        gameState.totalStars++;
        this.updateUI();

        if (gameState.starsCollected >= gameState.starsNeeded) {
          this.levelComplete();
        }
      }

      updateUI() {
        const elStars = document.getElementById('stars-display');
        const elLevel = document.getElementById('level-display');
        if (elStars) elStars.innerText = `${gameState.starsCollected}/${gameState.starsNeeded}`;
        if (elLevel) elLevel.innerText = gameState.level;
      }

      levelComplete() {
        this.scene.pause();
        gameState.paused = true;
        
        // æ›´æ–° UI
        document.getElementById('level-complete').classList.remove('hidden');
        document.getElementById('earned-stars').textContent = gameState.starsCollected;
        document.getElementById('total-stars').textContent = gameState.totalStars;
        
        const percent = Math.min(100, gameState.level * 10);
        document.getElementById('garden-percent').textContent = percent;
        document.getElementById('progress-fill').style.width = percent + '%';

        saveSystem.saveLocal({
            level: gameState.level + 1, // ä¿å­˜ä¸‹ä¸€å…³çŠ¶æ€
            totalStars: gameState.totalStars,
            totalTime: gameState.totalTime
        });
      }

      togglePause() {
        if (this.scene.isPaused('MainScene')) {
          this.scene.resume('MainScene');
          gameState.paused = false;
        } else {
          this.scene.pause('MainScene');
          gameState.paused = true;
        }
      }
    }

    // ==================== DOM äº‹ä»¶å¤„ç† ====================
    document.addEventListener('DOMContentLoaded', () => {
      // æ¨¡æ‹ŸåŠ è½½
      setTimeout(() => {
        const loader = document.getElementById('loading-screen');
        loader.style.opacity = '0';
        setTimeout(() => loader.style.display = 'none', 500);
      }, 800);

      // åŠ è½½å­˜æ¡£æ˜¾ç¤º
      checkSave();

      // æŒ‰é’®ç»‘å®š
      document.getElementById('new-game-btn').addEventListener('click', startNewGame);
      document.getElementById('continue-btn').addEventListener('click', continueGame);
      
      document.getElementById('pause-btn').addEventListener('click', () => {
        if (activeScene) {
            activeScene.togglePause();
            document.getElementById('pause-menu').classList.remove('hidden');
        }
      });

      document.getElementById('resume-btn').addEventListener('click', () => {
        if (activeScene) activeScene.togglePause();
        document.getElementById('pause-menu').classList.add('hidden');
      });

      document.getElementById('restart-btn').addEventListener('click', () => {
        document.getElementById('pause-menu').classList.add('hidden');
        if (activeScene) activeScene.scene.restart();
        gameState.paused = false;
      });

      document.getElementById('save-btn').addEventListener('click', () => {
        saveSystem.saveLocal({
          level: gameState.level,
          totalStars: gameState.totalStars,
          totalTime: gameState.totalTime
        });
        alert('ğŸ’¾ è¿›åº¦å·²ä¿å­˜');
      });

      document.getElementById('back-menu-btn').addEventListener('click', () => {
        document.getElementById('pause-menu').classList.add('hidden');
        document.getElementById('game-ui').classList.add('hidden');
        document.getElementById('main-menu').classList.remove('hidden');
        if (game) game.destroy(true);
        checkSave();
      });

      document.getElementById('next-level-btn').addEventListener('click', () => {
        document.getElementById('level-complete').classList.add('hidden');
        gameState.level++;
        if (gameState.level > 10) {
            showGameComplete();
        } else {
            gameState.paused = false;
            if (activeScene) activeScene.scene.restart();
        }
      });
      
      document.getElementById('back-menu-complete-btn').addEventListener('click', () => {
        document.getElementById('level-complete').classList.add('hidden');
        document.getElementById('game-ui').classList.add('hidden');
        document.getElementById('main-menu').classList.remove('hidden');
        if (game) game.destroy(true);
        checkSave();
      });

      document.getElementById('delete-save-btn').addEventListener('click', () => {
        if(confirm("ç¡®å®šè¦åˆ é™¤å­˜æ¡£å—ï¼Ÿ")) {
            saveSystem.deleteLocalSave();
            checkSave();
        }
      });

      // è®¾ç½®èœå•
      document.getElementById('settings-btn').addEventListener('click', () => {
        document.getElementById('pause-menu').classList.add('hidden');
        document.getElementById('settings-menu').classList.remove('hidden');
      });
      document.getElementById('close-settings-btn').addEventListener('click', () => {
        document.getElementById('settings-menu').classList.add('hidden');
        document.getElementById('pause-menu').classList.remove('hidden');
      });
      
      // éŸ³é‡
      document.getElementById('sfx-volume').addEventListener('input', (e) => gameState.sfxVolume = e.target.value);
    });

    function checkSave() {
      const save = saveSystem.getLocalSave();
      const contBtn = document.getElementById('continue-btn');
      const infoPanel = document.getElementById('load-info');
      
      if (save) {
        contBtn.classList.remove('hidden');
        infoPanel.classList.remove('hidden');
        document.getElementById('save-level').innerText = save.level;
        document.getElementById('save-stars').innerText = save.totalStars;
        document.getElementById('save-time').innerText = saveSystem.formatDuration(save.totalTime);
        document.getElementById('save-date').innerText = saveSystem.formatSaveDate(save.savedAt);
      } else {
        contBtn.classList.add('hidden');
        infoPanel.classList.add('hidden');
      }
    }

    function initGame() {
      document.getElementById('main-menu').classList.add('hidden');
      document.getElementById('game-ui').classList.remove('hidden');

      if (game) game.destroy(true);

      const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        parent: 'game-container',
        backgroundColor: '#87CEEB',
        physics: {
          default: 'arcade',
          arcade: { gravity: { y: 0 }, debug: false }
        },
        scale: {
          mode: Phaser.Scale.FIT,
          autoCenter: Phaser.Scale.CENTER_BOTH
        },
        scene: MainScene // ä½¿ç”¨ç±»
      };

      game = new Phaser.Game(config);
    }

    function startNewGame() {
      gameState = {
        level: 1,
        starsCollected: 0,
        totalStars: 0,
        starsNeeded: 10,
        totalTime: 0,
        sfxVolume: 1.0,
        musicVolume: 0.5,
        paused: false
      };
      initGame();
    }

    function continueGame() {
      const save = saveSystem.getLocalSave();
      if (save) {
        gameState.level = save.level;
        gameState.totalStars = save.totalStars;
        gameState.totalTime = save.totalTime;
        gameState.paused = false;
        initGame();
      }
    }

    function showGameComplete() {
        document.getElementById('game-complete').classList.remove('hidden');
        document.getElementById('final-stars').textContent = gameState.totalStars;
        document.getElementById('final-time').textContent = saveSystem.formatDuration(gameState.totalTime);
        document.getElementById('complete-date').textContent = new Date().toLocaleDateString();
        if (game) game.destroy(true);
    }

  </script>
</body>
</html>
